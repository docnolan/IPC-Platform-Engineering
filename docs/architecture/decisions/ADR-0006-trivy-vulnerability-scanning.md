# ADR-0006: Trivy for Container Vulnerability Scanning

## Status
Accepted

## Date
2026-01-25

## Context
Container images must be scanned for vulnerabilities before deployment to meet:

- CMMC Level 2 requirement for vulnerability management
- NIST 800-171 Control 3.11.2 (Vulnerability Scanning)
- Customer security requirements

Scanning should:
- Integrate with Azure DevOps pipelines
- Block builds with critical/high vulnerabilities
- Support documented risk acceptance (.trivyignore)
- Be fast enough for CI (< 2 minutes per image)

## Decision
We will use **Trivy** as the primary container vulnerability scanner in CI pipelines.

Implementation:
- Trivy runs post-build in each workload pipeline
- Exit code 1 on HIGH or CRITICAL by default
- `.trivyignore` per workload for documented risk acceptances
- Results logged in pipeline artifacts

Pipeline integration:
```yaml
- task: Bash@3
  displayName: Trivy Scan
  inputs:
    script: |
      trivy image --exit-code 1 --severity HIGH,CRITICAL \
        --ignorefile docker/$WORKLOAD/.trivyignore \
        $ACR_NAME.azurecr.io/dmc/$WORKLOAD:$BUILD_ID
```

## Consequences

### Positive
- **Open source**: No licensing cost; widely adopted
- **Fast**: DB cached, scans in ~30 seconds
- **Comprehensive**: OS packages, language deps, secrets detection
- **Flexible**: `.trivyignore` for documented exceptions
- **CI-friendly**: Exit codes for pass/fail decisions

### Negative
- **Database updates**: Requires periodic DB refresh (automated)
- **False positives**: Some CVEs require manual triage
- **Ignored CVEs**: Must document why in risk register

### Neutral
- Microsoft Defender for Containers provides additional scanning at registry level
- Both tools can run complementary

## Alternatives Considered

### Microsoft Defender for Containers only
- Pros: Azure-native, no pipeline changes
- Why not: Post-push scanning; doesn't block bad builds

### Anchore Grype
- Pros: Similar feature set
- Why not: Trivy more widely adopted; better documentation

### Snyk
- Pros: Rich features, developer experience
- Why not: Commercial license required; Trivy is sufficient

### Clair
- Pros: Kubernetes-native
- Why not: More complex setup; less CI-friendly

## Risk Acceptance Process

When a CVE cannot be fixed (no patch, false positive, etc.):

1. Add to workload's `.trivyignore` file
2. Add corresponding entry to `docs/security/risk-register.md`
3. Include Risk ID reference in .trivyignore comment
4. Periodic review of accepted risks (quarterly)

## References
- [Trivy documentation](https://aquasecurity.github.io/trivy/)
- [NIST 800-171 Control 3.11.2](https://nvd.nist.gov/800-171/Rev2/Control/3.11.2)
